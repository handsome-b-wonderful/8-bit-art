var x,y,width,height,r,g,b,ias,pre_pixel,pre_context,post_pixel,post_context,target_magnify,target_width,target_height,xoffset,yoffset,pixels_per_x,pixels_per_y,sampleSize,imageData,mapColor,average_colors,palette=[{id:"palette-color-01",name:"red",color:{r:255,g:0,b:0}},{id:"palette-color-02",name:"green",color:{r:0,g:255,b:0}},{id:"palette-color-03",name:"blue",color:{r:0,g:0,b:255}},{id:"palette-color-04",name:"black",color:{r:0,g:0,b:0}},{id:"palette-color-05",name:"white",color:{r:255,g:255,b:255}},{id:"palette-color-06",name:"cyan",color:{r:0,g:255,b:255}},{id:"palette-color-07",name:"magenta",color:{r:255,g:0,b:255}},{id:"palette-color-08",name:"yellow",color:{r:255,g:255,b:0}},{id:"palette-color-09",name:"purple",color:{r:128,g:0,b:128}},{id:"palette-color-10",name:"brown",color:{r:101,g:67,b:33}},{id:"palette-color-11",name:"burgundy",color:{r:128,g:0,b:32}},{id:"palette-color-12",name:"navy blue",color:{r:0,g:0,b:128}},{id:"palette-color-13",name:"forest green",color:{r:34,g:139,b:34}},{id:"palette-color-14",name:"orange",color:{r:255,g:165,b:0}},{id:"palette-color-15",name:"teal",color:{r:0,g:128,b:128}}];function mapColorToPalette(e,t,o){for(var a,r,l,i,p,n,g=Number.MAX_VALUE,c=0;c<palette.length;c++)(p=(r=(a=palette[c].color).r-e)*r+(l=a.g-t)*l+(i=a.b-o)*i)<g&&(g=p,n=palette[c]);return void 0===n&&(n=palette[0]),n}function componentToHex(e){var t=e.toString(16);return 1==t.length?"0"+t:t}function rgbToHex(e,t,o){return"#"+componentToHex(e)+componentToHex(t)+componentToHex(o)}function jumpTo(e){var t=document.getElementById(e).offsetTop;window.scrollTo(0,t)}function selectImage(e){if(e.files&&e.files[0]){var t=new FileReader;t.onload=function(e){$("#photo").attr("src",e.target.result)},t.readAsDataURL(e.files[0])}}function cropDone(e,t){x=t.x1,y=t.y1,width=t.width,height=t.height,$("#x").text(x),$("#y").text(y),$("#width").text(width),$("#height").text(height),$("#pixelate").show(),jumpTo("pixelate")}$(document).ready(function(){for(var e=0;e<palette.length;e++){var t=document.createElement("span");t.id=palette[e].id,t.className="palette-color",t.style.cssText="border-color:"+rgbToHex(palette[e].color.r,palette[e].color.g,palette[e].color.b)+";",t.innerHTML=palette[e].name,$("#palette").append(t)}$("#imgInp").change(function(){$("#cropper").show(),jumpTo("cropper"),selectImage(this)}),(ias=$("#photo").imgAreaSelect({instance:!0})).setOptions({show:!0,handles:!0,movable:!0,onSelectEnd:cropDone}),ias.update(),$("#photo").on("load",function(){ias.setSelection(0,0,0,0,!0),ias.update()}),$("#pixelization").click(function(e){e.preventDefault(),(pre_pixel=document.getElementById("pre_pixel")).width=width,pre_pixel.height=height,(pre_context=pre_pixel.getContext("2d")).drawImage(document.getElementById("photo"),x,y,width,height,0,0,width,height),target_magnify=Number($("#target_magnify").val()),post_pixel=document.getElementById("post_pixel"),target_width=Number($("#target_width").val()),target_height=Number($("#target_height").val()),post_pixel.width=target_width*target_magnify,post_pixel.height=target_height*target_magnify,post_context=post_pixel.getContext("2d"),pixels_per_x=width/target_width,pixels_per_y=height/target_height,xoffset=0,yoffset=0,average_colors="average"===$("input[name=sample_type]:checked").val();for(var t=0;t<target_width*target_magnify;t+=target_magnify){for(var o=0;o<target_height*target_magnify;o+=target_magnify){if(imageData=pre_context.getImageData(xoffset,yoffset,pixels_per_x,pixels_per_y),average_colors){r=0,g=0,b=0,sampleSize=imageData.height*imageData.width;for(var a=0;a<4*sampleSize;a+=4)r+=imageData.data[a],g+=imageData.data[a+1],b+=imageData.data[a+2];mapColor=mapColorToPalette(Math.round(r/sampleSize),Math.round(g/sampleSize),Math.round(b/sampleSize))}else mapColor=mapColorToPalette(imageData.data[0],imageData.data[1],imageData.data[2]);post_context.fillStyle="rgba("+mapColor.color.r+","+mapColor.color.g+","+mapColor.color.b+", 1.0 )",post_context.fillRect(t,o,target_magnify,target_magnify),yoffset+=pixels_per_y}yoffset=0,xoffset+=pixels_per_x,$("#mapper").show(),jumpTo("mapper")}}),$("#buildit").click(function(e){e.preventDefault(),$("#supplies").empty(),$("#pattern").empty();for(var t=document.getElementById("post_pixel"),o=t.getContext("2d").getImageData(0,0,t.width,t.height).data,a=[],r=0;r<palette.length;r++)palette[r].count=0;for(var l=0;l<t.height;l++){for(var i=4*l*t.width,p=[],n=0,g=null,c=0;c<t.width;c++)mapColor=mapColorToPalette(o[i+4*c],o[i+4*c+1],o[i+4*c+2]),palette.find(e=>e.id==mapColor.id).count++,g!=mapColor.id&&(n>0&&(p.push({color:palette.find(e=>e.id==g).name,count:n}),n=0),g=mapColor.id),n++;n>0&&p.push({color:palette.find(e=>e.id==g).name,count:n}),a.push(p)}for(r=0;r<palette.length;r++)$("#supplies").append(`<li>${palette[r].name}: ${palette[r].count}</li>`);for(l=0;l<a.length;l++){var m=a[l],d=`${l+1}:`;for(c=0;c<m.length;c++)d+=` ${m[c].count} ${m[c].color}`;$("#pattern").append(`<li>${d}</li>`)}$("#buildsheets").show(),jumpTo("buildsheets")})});