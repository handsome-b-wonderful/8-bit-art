var x,y,width,height;var r,g,b;var ias;var pre_pixel,pre_context,post_pixel,post_context;var target_magnify,target_width,target_height;var xoffset,yoffset;var pixels_per_x,pixels_per_y;var sampleSize,imageData,mapColor;var average_colors;var palette=[{id:"palette-color-01",name:"red",color:{r:255,g:0,b:0}},{id:"palette-color-02",name:"green",color:{r:0,g:255,b:0}},{id:"palette-color-03",name:"blue",color:{r:0,g:0,b:255}},{id:"palette-color-04",name:"black",color:{r:0,g:0,b:0}},{id:"palette-color-05",name:"white",color:{r:255,g:255,b:255}},{id:"palette-color-06",name:"cyan",color:{r:0,g:255,b:255}},{id:"palette-color-07",name:"magenta",color:{r:255,g:0,b:255}},{id:"palette-color-08",name:"yellow",color:{r:255,g:255,b:0}},{id:"palette-color-09",name:"purple",color:{r:128,g:0,b:128}},{id:"palette-color-10",name:"brown",color:{r:101,g:67,b:33}},{id:"palette-color-11",name:"burgundy",color:{r:128,g:0,b:32}},{id:"palette-color-12",name:"navy blue",color:{r:0,g:0,b:128}},{id:"palette-color-13",name:"forest green",color:{r:34,g:139,b:34}},{id:"palette-color-14",name:"orange",color:{r:255,g:165,b:0}},{id:"palette-color-15",name:"teal",color:{r:0,g:128,b:128}}];function mapColorToPalette(e,f,m){var h,a,k,l,n,d;var c=Number.MAX_VALUE;for(var j=0;j<palette.length;j++){h=palette[j].color;a=(h.r-e);k=(h.g-f);l=(h.b-m);n=a*a+k*k+l*l;if(n<c){c=n;d=palette[j]}}if(d===undefined){d=palette[0]}return(d)}function componentToHex(d){var a=d.toString(16);return a.length==1?"0"+a:a}function rgbToHex(d,c,a){return"#"+componentToHex(d)+componentToHex(c)+componentToHex(a)}function jumpTo(a){var c=document.getElementById(a).offsetTop;window.scrollTo(0,c)}function selectImage(c){if(c.files&&c.files[0]){var a=new FileReader();a.onload=function(d){$("#photo").attr("src",d.target.result)};a.readAsDataURL(c.files[0])}}function cropDone(a,c){x=c.x1;y=c.y1;width=c.width;height=c.height;$("#x").text(x);$("#y").text(y);$("#width").text(width);$("#height").text(height);$("#pixelate").show();jumpTo("pixelate")}$(document).ready(function(){for(var a=0;a<palette.length;a++){var c=document.createElement("span");c.id=palette[a].id;c.className="palette-color";c.style.cssText="border-color:"+rgbToHex(palette[a].color.r,palette[a].color.g,palette[a].color.b)+";";c.innerHTML=palette[a].name;$("#palette").append(c)}$("#imgInp").change(function(){$("#cropper").show();jumpTo("cropper");selectImage(this)});ias=$("#photo").imgAreaSelect({instance:true});ias.setOptions({show:true,handles:true,movable:true,onSelectEnd:cropDone});ias.update();$("#photo").on("load",function(){ias.setSelection(0,0,0,0,true);ias.update()});$("#pixelization").click(function(f){f.preventDefault();pre_pixel=document.getElementById("pre_pixel");pre_pixel.width=width;pre_pixel.height=height;pre_context=pre_pixel.getContext("2d");pre_context.drawImage(document.getElementById("photo"),x,y,width,height,0,0,width,height);target_magnify=Number($("#target_magnify").val());post_pixel=document.getElementById("post_pixel");target_width=Number($("#target_width").val());target_height=Number($("#target_height").val());post_pixel.width=target_width*target_magnify;post_pixel.height=target_height*target_magnify;post_context=post_pixel.getContext("2d");pixels_per_x=width/target_width;pixels_per_y=height/target_height;xoffset=0;yoffset=0;sampleSize;imageData;mapColor;if($("input[name=sample_type]:checked").val()==="average"){average_colors=true}else{average_colors=false}for(var h=0;h<target_width*target_magnify;h+=target_magnify){for(var e=0;e<target_height*target_magnify;e+=target_magnify){imageData=pre_context.getImageData(xoffset,yoffset,pixels_per_x,pixels_per_y);if(average_colors){r=0;g=0;b=0;sampleSize=imageData.height*imageData.width;for(var d=0;d<sampleSize*4;d+=4){r+=imageData.data[d];g+=imageData.data[d+1];b+=imageData.data[d+2]}mapColor=mapColorToPalette(Math.round(r/sampleSize),Math.round(g/sampleSize),Math.round(b/sampleSize))}else{mapColor=mapColorToPalette(imageData.data[0],imageData.data[1],imageData.data[2])}post_context.fillStyle="rgba("+mapColor.color.r+","+mapColor.color.g+","+mapColor.color.b+", 1.0 )";post_context.fillRect(h,e,target_magnify,target_magnify);yoffset+=pixels_per_y}yoffset=0;xoffset+=pixels_per_x;$("#mapper").show();jumpTo("mapper")}});$("#buildit").click(function(d){d.preventDefault();$("#buildsheets").show();jumpTo("buildsheets")})});